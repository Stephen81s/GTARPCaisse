<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>RP Business System â€” Accueil</title>

  <!-- ============================================================
       STYLE GLOBAL
  ============================================================ -->
  <?!= include('style_admin'); ?>

  <!-- ============================================================
       SCRIPT NAVIGATION (chargÃ© AVANT le script principal)
       IMPORTANT : buildMenu(), addMenuLink(), onPageLoaded()
       doivent exister AVANT loadPage()
  ============================================================ -->
  <?!= include('script_navigation'); ?>
</head>

<body class="theme-light">

  <!-- ============================================================
       MENU LATÃ‰RAL â€” DYNAMIQUE SELON LE RÃ”LE
  ============================================================ -->
  <aside id="sidebar">

    <div class="menu-section">
      <h2>ğŸ“Œ Navigation</h2>
      <ul id="menu-links"></ul>
    </div>

    <div class="menu-section">
      <h2>âš™ï¸ ParamÃ¨tres</h2>

      <label for="themeSelect">ThÃ¨me :</label>
      <select id="themeSelect" onchange="changeTheme()">
        <option value="light">Clair</option>
        <option value="dark">Sombre</option>
      </select>
    </div>

  </aside>

  <!-- ============================================================
       CONTENEUR PRINCIPAL (pages dynamiques)
  ============================================================ -->
  <main class="main-container">
    <div id="page-frame" class="page-frame">Chargementâ€¦</div>
  </main>

  <!-- ============================================================
       SCRIPT PRINCIPAL â€” SPA + THEME + INIT
  ============================================================ -->
  <script>
  console.log("ğŸŸ¦ [index] Script principal chargÃ©.");

  /* ============================================================
     VARIABLE GLOBALE â€” DOIT ÃŠTRE UNIQUE
  ============================================================ */
  let currentPage = null;

  /* ============================================================
     THÃˆME CLAIR / SOMBRE
  ============================================================ */
  function loadTheme() {
    const theme = localStorage.getItem("theme") || "light";
    document.body.className = "theme-" + theme;
    document.getElementById("themeSelect").value = theme;
  }

  function changeTheme() {
    const theme = document.getElementById("themeSelect").value;
    localStorage.setItem("theme", theme);
    loadTheme();
  }

  /* ============================================================
     ROUTER SPA â€” CHARGEMENT DYNAMIQUE DES PAGES
  ============================================================ */
  function loadPage(pageName) {

    if (currentPage === pageName) {
      console.log("â„¹ï¸ [index] Page dÃ©jÃ  active :", pageName);
      return;
    }

    console.log("ğŸ“„ [index] Demande dâ€™ouverture :", pageName);
    currentPage = pageName;

    google.script.run
      .withSuccessHandler(html => {

        console.log("ğŸŸ© [index] Page reÃ§ue :", pageName);

        const frame = document.getElementById("page-frame");

        // 1) EXTRACTION DES SCRIPTS
        const temp = document.createElement("div");
        temp.innerHTML = html;

        const scripts = [...temp.querySelectorAll("script")];
        scripts.forEach(s => s.remove());

        // 2) INJECTION DU HTML
        frame.innerHTML = temp.innerHTML;

        // 2.5) MISE Ã€ JOUR DU MENU ACTIF
        if (typeof onPageLoaded === "function") {
          onPageLoaded(pageName);
        }

        // 3) RÃ‰INJECTION DES SCRIPTS
        scripts.forEach(oldScript => {
          const newScript = document.createElement("script");

          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;

          frame.appendChild(newScript);
        });

        console.log("ğŸŸ© [index] Injection terminÃ©e. Appel initPage()â€¦");

        // 4) APPEL AUTOMATIQUE DE initPage()
        if (typeof initPage === "function") {
          console.log("ğŸŸ¦ [index] initPage() dÃ©tectÃ© â†’ exÃ©cution");
          initPage();
        } else {
          console.warn("ğŸŸ§ [index] Aucun initPage() trouvÃ© dans le fragment");
        }

      })
      .withFailureHandler(err => {
        console.error("âŒ [index] ERREUR lors du chargement :", err);
      })
      .include(pageName);
  }

  /* ============================================================
     CHARGEMENT INITIAL
  ============================================================ */
  window.onload = function () {
    loadTheme();

    google.script.run
      .withSuccessHandler(role => {
        console.log("ğŸŸ¦ [index] RÃ´le utilisateur :", role);
        buildMenu(role);
        loadPage("page_accueil");
      })
      .ui_getUserRole();
  };

  </script>

  <!-- ============================================================
       SCRIPT ADMIN PANEL (JS GLOBAL)
  ============================================================ -->
  <?!= include('script_panel_admin'); ?>

</body>
</html>