<!--
    FICHIER : commandes.html
    ARCHITECTURE : PRO 2026
    AUTEUR : Stephen

    DESCRIPTION :
        - Module de gestion des commandes
        - Lecture, création, mise à jour, suppression
        - Table dynamique + formulaire modal
-->

<section class="page-container">

    <h1>Commandes</h1>

    <button class="btn-primary" onclick="openCommandeModal()">+ Ajouter une commande</button>

    <table class="pro-table" id="table-commandes">
        <thead>
            <tr>
                <th>ID</th>
                <th>Joueur</th>
                <th>Entreprise</th>
                <th>Montant</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rempli dynamiquement -->
        </tbody>
    </table>

</section>


<!-- MODAL CREATION / EDITION -->
<div id="commande-modal" class="modal hidden">
    <div class="modal-content">
        <h2 id="modal-title">Nouvelle commande</h2>

        <label>Joueur</label>
        <select id="cmd-joueur"></select>

        <label>Entreprise</label>
        <select id="cmd-entreprise"></select>

        <label>Montant</label>
        <input type="number" id="cmd-montant" />

        <label>Statut</label>
        <select id="cmd-statut"></select>

        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCommandeModal()">Annuler</button>
            <button class="btn-primary" onclick="saveCommande()">Enregistrer</button>
        </div>
    </div>
</div>


<style>
    .page-container {
        padding: 30px;
    }

    .btn-primary {
        background: #0078ff;
        color: white;
        padding: 10px 18px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .btn-secondary {
        background: #ccc;
        padding: 10px 18px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .pro-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .pro-table th, .pro-table td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }

    .pro-table th {
        background: #f5f5f5;
        text-align: left;
    }

    .modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal.hidden {
        display: none;
    }

    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 350px;
    }

    .modal-content input,
    .modal-content select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>


<script>
let editingCommandeId = null;

/***************************************************************
 * INITIALISATION
 ***************************************************************/
async function init_commandes() {
    await loadJoueurs();
    await loadEntreprises();
    await loadStatuts();
    loadCommandes();
}


/***************************************************************
 * CHARGEMENT DES JOUEURS
 ***************************************************************/
async function loadJoueurs() {
    const joueurs = await apiCall("api_getJoueurs");

    const select = document.getElementById("cmd-joueur");
    select.innerHTML = "";

    joueurs.forEach(j => {
        const opt = document.createElement("option");
        opt.value = j.id;
        opt.textContent = `${j.nom} ${j.prenom}`;
        select.appendChild(opt);
    });
}


/***************************************************************
 * CHARGEMENT DES ENTREPRISES
 ***************************************************************/
async function loadEntreprises() {
    const entreprises = await apiCall("api_getEntreprises");

    const select = document.getElementById("cmd-entreprise");
    select.innerHTML = "";

    entreprises.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.nom;
        select.appendChild(opt);
    });
}


/***************************************************************
 * CHARGEMENT DES STATUTS
 ***************************************************************/
async function loadStatuts() {
    const statuts = await apiCall("api_getCommandeStatuts");

    const select = document.getElementById("cmd-statut");
    select.innerHTML = "";

    statuts.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.value;
        opt.textContent = s.description;
        select.appendChild(opt);
    });
}


/***************************************************************
 * CHARGEMENT DES COMMANDES
 ***************************************************************/
async function loadCommandes() {
    const data = await apiCall("api_getCommandes");

    const tbody = document.querySelector("#table-commandes tbody");
    tbody.innerHTML = "";

    data.forEach(c => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.joueur_id}</td>
            <td>${c.entreprise_id}</td>
            <td>${formatPrice(c.montant)}</td>
            <td>${c.statut}</td>
            <td>
                <button onclick="editCommande('${c.id}', '${c.joueur_id}', '${c.entreprise_id}', '${c.montant}', '${c.statut}')">Modifier</button>
                <button onclick="deleteCommande('${c.id}')">Supprimer</button>
            </td>
        `;

        tbody.appendChild(tr);
    });
}


/***************************************************************
 * MODAL
 ***************************************************************/
function openCommandeModal() {
    editingCommandeId = null;
    document.getElementById("modal-title").textContent = "Nouvelle commande";
    document.getElementById("cmd-joueur").value = "";
    document.getElementById("cmd-entreprise").value = "";
    document.getElementById("cmd-montant").value = "";
    document.getElementById("cmd-statut").value = "";
    document.getElementById("commande-modal").classList.remove("hidden");
}

function closeCommandeModal() {
    document.getElementById("commande-modal").classList.add("hidden");
}


/***************************************************************
 * EDITION
 ***************************************************************/
function editCommande(id, joueur_id, entreprise_id, montant, statut) {
    editingCommandeId = id;
    document.getElementById("modal-title").textContent = "Modifier commande";
    document.getElementById("cmd-joueur").value = joueur_id;
    document.getElementById("cmd-entreprise").value = entreprise_id;
    document.getElementById("cmd-montant").value = montant;
    document.getElementById("cmd-statut").value = statut;
    document.getElementById("commande-modal").classList.remove("hidden");
}


/***************************************************************
 * SAUVEGARDE
 ***************************************************************/
async function saveCommande() {
    const joueur_id = document.getElementById("cmd-joueur").value;
    const entreprise_id = document.getElementById("cmd-entreprise").value;
    const montant = document.getElementById("cmd-montant").value;
    const statut = document.getElementById("cmd-statut").value;

    if (!joueur_id || !entreprise_id || !montant || !statut) {
        showError("Veuillez remplir tous les champs");
        return;
    }

    if (editingCommandeId) {
        await apiCall("api_updateCommande", editingCommandeId, { joueur_id, entreprise_id, montant, statut });
        showSuccess("Commande mise à jour");
    } else {
        await apiCall("api_createCommande", joueur_id, entreprise_id, montant, statut);
        showSuccess("Commande créée");
    }

    closeCommandeModal();
    loadCommandes();
}


/***************************************************************
 * SUPPRESSION
 ***************************************************************/
async function deleteCommande(id) {
    if (!confirm("Supprimer cette commande ?")) return;

    await apiCall("api_deleteCommande", id);
    showSuccess("Commande supprimée");
    loadCommandes();
}
</script>