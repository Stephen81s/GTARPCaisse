<script>
/********************************************************************
 * @file script_caisse.html
 * @description Module CAISSE â€” Front complet :
 *              - Chargement des listes (opÃ©rations, employÃ©s, clients, paiements)
 *              - Gestion des lignes articles (template â†’ clone â†’ ligne visible)
 *              - Calculs : prix, remises, totaux + livraison
 *              - Couleurs selon type caisse (legal / illegal / violet / rupture)
 *              - VÃ©rification du stock
 *
 * Auteur : Stephen
 * Version : 5.4.0
 * Mis Ã  jour : 2026-02-10 â€¢ 13:30 (CET)
 *
 * Contraintes :
 *   - Doit Ãªtre chargÃ© AVANT script_init_html.html
 *   - Repose sur la structure de interface_caisse.html
 ********************************************************************/

console.log("ðŸ“„ [CAISSE] Module caisse chargÃ©.");

/********************************************************************
 * VARIABLES GLOBALES
 ********************************************************************/
let ARTICLES_DATA = {};
let TYPES_OPERATION = {};
let ARTICLES_READY = false;

/********************************************************************
 * INIT CAISSE â€” appelÃ© par script_init_html
 ********************************************************************/
function initCaisse(data) {
  console.log("ðŸš€ [CAISSE] Initialisationâ€¦");

  TYPES_OPERATION = data.typesOperation || [];

  remplirTypesOperation(data.typesOperation);
  remplirEmployes(data.employes);
  remplirClients(data.clients);
  remplirPaiements(data.paiements);
  remplirArticles(data.articles);

  ajouterLigneArticle();

  console.log("ðŸŸ© [CAISSE] Initialisation terminÃ©e.");
}

/********************************************************************
 * REMPLISSAGE DES LISTES
 ********************************************************************/
function remplirTypesOperation(types) {
  const sel = document.getElementById("typeOperation");
  sel.innerHTML = "";

  (types || []).forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.nom;
    opt.textContent = t.nom;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", updateAllLines);
}

function remplirEmployes(list) {
  const sel = document.getElementById("employe");
  sel.innerHTML = "";

  (list || []).forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.nom;
    opt.textContent = e.nom;
    sel.appendChild(opt);
  });
}

function remplirClients(list) {
  console.log("ðŸ“¥ [CAISSE] Chargement des clientsâ€¦");

  const sel = document.getElementById("client");
  sel.innerHTML = "";

  const empty = document.createElement("option");
  empty.value = "";
  empty.textContent = "";
  sel.appendChild(empty);

  (list || []).forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.full;
    opt.textContent = c.full;
    sel.appendChild(opt);
  });

  sel.value = "";

  console.log("ðŸŸ© [CAISSE] Clients chargÃ©s, aucun sÃ©lectionnÃ©.");
}

function remplirPaiements(list) {
  console.log("ðŸ“¥ [CAISSE] Chargement des modes de paiementâ€¦");

  const sel = document.getElementById("paiement");
  sel.innerHTML = "";

  (list || []).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  });

  console.log("ðŸŸ© [CAISSE] Modes de paiement chargÃ©s :", (list || []).length);
}

function remplirArticles(list) {
  console.log("ðŸ“¥ [CAISSE] Chargement articlesâ€¦");

  ARTICLES_READY = false;
  ARTICLES_DATA = {};

  const dl = document.getElementById("articlesList");
  dl.innerHTML = "";

  (list || []).forEach(a => {
    ARTICLES_DATA[a.nom] = a;

    const opt = document.createElement("option");
    opt.value = a.nom;
    dl.appendChild(opt);
  });

  ARTICLES_READY = true;

  console.log("ðŸŸ© [CAISSE] Articles chargÃ©s :", Object.keys(ARTICLES_DATA).length);
}

/********************************************************************
 * TEMPLATE â†’ CLONE â†’ LIGNE VISIBLE (CORRIGÃ‰)
 ********************************************************************/
function ajouterLigneArticle() {
  console.log("âž• [CAISSE] Ajout dâ€™une ligneâ€¦");

  const template = document.querySelector(".template-ligne");
  if (!template) {
    console.error("ðŸ’¥ [CAISSE] Template .template-ligne introuvable");
    return;
  }

  const clone = template.cloneNode(true);

  // Correction critique : conserver la classe .ligne-article
  clone.classList.remove("template-ligne");
  clone.classList.add("ligne-article");

  clone.style.display = "flex";
  clone.querySelector(".articleInput").value = "";
  clone.querySelector(".prixUnitaire").value = "";
  clone.querySelector(".quantite").value = 1;
  clone.querySelector(".remiseMontant").value = "";
  clone.querySelector(".totalLigne").value = "";

  attachLineEvents(clone);
  document.getElementById("lignesReelles").appendChild(clone);

  // Initialisation visuelle
  updateLine(clone);
}

document.getElementById("ajouterLigne").addEventListener("click", ajouterLigneArticle);

/********************************************************************
 * ATTACHEMENT DES Ã‰VÃ‰NEMENTS SUR UNE LIGNE
 ********************************************************************/
function attachLineEvents(ligne) {
  const articleInput   = ligne.querySelector(".articleInput");
  const quantiteInput  = ligne.querySelector(".quantite");
  const remiseInput    = ligne.querySelector(".remiseMontant");
  const remiseTypeSel  = ligne.querySelector(".remiseType");
  const btnDupliquer   = ligne.querySelector(".dupliquerLigne");
  const btnSupprimer   = ligne.querySelector(".supprimerLigne");

  if (!articleInput || !quantiteInput || !remiseInput || !remiseTypeSel) {
    console.error("ðŸ’¥ [CAISSE] Structure de ligne invalide, impossible dâ€™attacher les Ã©vÃ©nements.");
    return;
  }

  articleInput.addEventListener("input", () => {
    console.log("âœï¸ [CAISSE] Article modifiÃ© :", articleInput.value);
    updateLine(ligne);
  });

  quantiteInput.addEventListener("input", () => {
    updateLine(ligne);
  });

  remiseInput.addEventListener("input", () => {
    updateLine(ligne);
  });

  remiseTypeSel.addEventListener("change", () => {
    updateLine(ligne);
  });

  if (btnDupliquer) {
    btnDupliquer.addEventListener("click", () => {
      console.log("ðŸ“„ [CAISSE] Duplication de ligneâ€¦");
      ajouterLigneArticle();
    });
  }

  if (btnSupprimer) {
    btnSupprimer.addEventListener("click", () => {
      console.log("ðŸ—‘ [CAISSE] Suppression de ligneâ€¦");
      ligne.remove();
      updateTotals();
    });
  }
}

/********************************************************************
 * RECALCUL GLOBAL
 ********************************************************************/
function updateAllLines() {
  console.log("ðŸ”„ [CAISSE] Recalcul de toutes les lignesâ€¦");

  document.querySelectorAll("#lignesReelles .ligne-article").forEach(ligne => {
    updateLine(ligne);
  });

  updateTotals();
}

/********************************************************************
 * MISE Ã€ JOUR Dâ€™UNE LIGNE
 ********************************************************************/
function updateLine(ligne) {
  if (!ARTICLES_READY) {
    console.warn("âš ï¸ [CAISSE] Articles non prÃªts, updateLine ignorÃ©.");
    return;
  }

  const articleInput  = ligne.querySelector(".articleInput");
  const prixInput     = ligne.querySelector(".prixUnitaire");
  const qteInput      = ligne.querySelector(".quantite");
  const remiseInput   = ligne.querySelector(".remiseMontant");
  const remiseTypeSel = ligne.querySelector(".remiseType");
  const totalInput    = ligne.querySelector(".totalLigne");

  const nomArticle = (articleInput.value || "").trim();
  const qte        = Number(qteInput.value) || 0;
  const remiseVal  = Number(remiseInput.value) || 0;
  const remiseType = remiseTypeSel.value || "â‚¬";

  // Reset visuel de base
  ligne.classList.remove("legal", "illegal", "violet", "rupture");
  prixInput.value  = "";
  totalInput.value = "";

  if (!nomArticle) {
    // Ligne vide â†’ rien Ã  calculer
    return;
  }

  const art = ARTICLES_DATA[nomArticle];
  if (!art) {
    console.warn("âš ï¸ [CAISSE] Article introuvable dans ARTICLES_DATA :", nomArticle);
    return;
  }

  // Prix unitaire = prixVente
  const pu = Number(art.prixVente) || 0;
  prixInput.value = pu.toFixed(2);

  // Application de la remise
  let totalBrut = pu * qte;
  let totalNet  = totalBrut;

  if (remiseVal > 0) {
    if (remiseType === "â‚¬") {
      totalNet = Math.max(0, totalBrut - remiseVal);
    } else if (remiseType === "%") {
      const coef = Math.max(0, 1 - (remiseVal / 100));
      totalNet = totalBrut * coef;
    }
  }

  totalInput.value = totalNet.toFixed(2);

  // Couleurs selon type caisse
  const typeCaisse = String(art.typeCaisse || "").trim().toLowerCase();

  if (typeCaisse === "legal") {
    ligne.classList.add("legal");
  } else if (typeCaisse === "illegal") {
    ligne.classList.add("illegal");
  } else if (typeCaisse === "violet") {
    ligne.classList.add("violet");
  }

  // VÃ©rification du stock
  const stock = Number(art.stock) || 0;
  if (stock > 0 && qte > stock) {
    console.warn("âš ï¸ [CAISSE] Rupture potentielle : demandÃ©", qte, " / stock", stock, "pour", nomArticle);
    ligne.classList.add("rupture");
  }

  // Mise Ã  jour du total global
  updateTotals();
}

/********************************************************************
 * MISE Ã€ JOUR DU TOTAL GLOBAL (articles + livraison)
 ********************************************************************/
function updateTotals() {
  let totalArticles = 0;

  document.querySelectorAll("#lignesReelles .ligne-article").forEach(ligne => {
    const totalInput = ligne.querySelector(".totalLigne");
    const val = Number(totalInput.value) || 0;
    totalArticles += val;
  });

  // Livraison
  const livMontantInput = document.getElementById("livraisonMontant");
  const livTypeSelect   = document.getElementById("livraisonType");

  const livVal  = Number(livMontantInput.value) || 0;
  const livType = livTypeSelect.value || "â‚¬";

  let totalFinal = totalArticles;

  if (livVal > 0) {
    if (livType === "â‚¬") {
      totalFinal += livVal;
    } else if (livType === "%") {
      totalFinal += totalArticles * (livVal / 100);
    }
  }

  const spanTotal = document.getElementById("totalArticle");
  spanTotal.textContent = totalFinal.toFixed(2);

  console.log("ðŸ§® [CAISSE] Total articles :", totalArticles.toFixed(2), "| Total final :", totalFinal.toFixed(2));
}
</script>
